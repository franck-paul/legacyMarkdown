"use strict";dotclear.md_options=dotclear.getData("md_options"),jsToolBar.prototype.elements.md_blocks={type:"combo",title:"block format",options:{none:"-- none --",nonebis:"- block format -",p:"Paragraph",h1:"Header 1",h2:"Header 2",h3:"Header 3",h4:"Header 4",h5:"Header 5",h6:"Header 6"},markdown:{list:["nonebis","h3","h4","h5"],fn(e){switch(e){case"nonebis":this.textarea.focus();break;case"h3":this.encloseSelection("### ");break;case"h4":this.encloseSelection("#### ");break;case"h5":this.encloseSelection("##### ")}this.toolNodes.md_blocks.value="nonebis"}}},jsToolBar.prototype.elements.md_space0={type:"space",format:{markdown:!0}},jsToolBar.prototype.elements.md_strong={type:"button",title:"Strong emphasis",shortkey:"KeyB",shortkey_name:"B",fn:{markdown(){this.singleTag("**")}}},jsToolBar.prototype.elements.md_em={type:"button",title:"Emphasis",shortkey:"KeyI",shortkey_name:"I",fn:{markdown(){this.singleTag("*")}}},jsToolBar.prototype.elements.md_ins={type:"button",title:"Inserted",shortkey:"KeyU",shortkey_name:"U",fn:{markdown(){this.singleTag("<ins>","</ins>")}}},jsToolBar.prototype.elements.md_del={type:"button",title:"Deleted",shortkey:"KeyD",shortkey_name:"D",fn:{markdown(){this.singleTag("<del>","</del>")}}},jsToolBar.prototype.elements.md_quote={type:"button",title:"Inline quote",fn:{},async prompt(e=null){const t=new jsDialog({title:this.toolbar.querySelector(".jstb_md_quote")?.title||this.elements.md_quote.title,confirm_label:dotclear.md_options.dialog.ok,cancel_label:dotclear.md_options.dialog.cancel,fields:[{default:this.elements.md_quote.dialog.default_url,html:this.elements.md_quote.dialog.url},{default:this.elements.md_quote.dialog.default_lang,html:this.elements.md_quote.dialog.language}]});await t.prompt().then((t=>{if(t&&e){const o=JSON.parse(t);e({cite:this.stripBaseURL(o[0]),lang:o[1]})}else this.toolbar.querySelector(".jstb_md_quote").focus()}))}},jsToolBar.prototype.elements.md_quote.fn.markdown=async function(){await this.elements.md_quote.prompt.call(this,(e=>{let t="<q";e.cite&&(t=`${t} cite="${e.cite}"`),e.lang&&(t=`${t} lang="${e.lang}"`),t=`${t}>`,this.encloseSelection(t,"</q>")}))},jsToolBar.prototype.elements.md_code={type:"button",title:"Code",fn:{markdown(){this.singleTag("`")}}},jsToolBar.prototype.elements.md_mark={type:"button",title:"Mark",fn:{markdown(){this.singleTag("<mark>","</mark>")}}},jsToolBar.prototype.elements.md_foreign={type:"button",title:"Foreign text",fn:{},async prompt(e=null){const t=new jsDialog({title:this.toolbar.querySelector(".jstb_md_foreign")?.title||this.elements.md_foreign.title,confirm_label:dotclear.md_options.dialog.ok,cancel_label:dotclear.md_options.dialog.cancel,fields:[{default:this.elements.md_foreign.dialog.default_lang,html:this.elements.md_foreign.dialog.language}]});await t.prompt().then((t=>{if(t&&e){const o=JSON.parse(t);e({lang:o[0]})}else this.toolbar.querySelector(".jstb_md_foreign").focus()}))}},jsToolBar.prototype.elements.md_foreign.fn.markdown=async function(){await this.elements.md_foreign.prompt.call(this,(e=>{this.encloseSelection(`<i lang="${e.lang}">`,"</i>")}))},jsToolBar.prototype.elements.md_space1={type:"space",format:{markdown:!0}},jsToolBar.prototype.elements.md_br={type:"button",title:"Line break",fn:{markdown(){this.encloseSelection("  \n","")}}},jsToolBar.prototype.elements.md_space2={type:"space",format:{markdown:!0}},jsToolBar.prototype.elements.md_blockquote={type:"button",title:"Blockquote",fn:{markdown(){this.encloseSelection("\n","",(e=>`> ${e.replace(/\r/g,"").replace(/\n/g,"\n> ")}`))}}},jsToolBar.prototype.elements.md_pre={type:"button",title:"Preformated text",fn:{markdown(){this.encloseSelection("<pre>\n","\n</pre>")}}},jsToolBar.prototype.elements.md_ul={type:"button",title:"Unordered list",fn:{markdown(){this.encloseSelection("","",(e=>`* ${e.replace(/\r/g,"").replace(/\n/g,"\n* ")}`))}}},jsToolBar.prototype.elements.md_ol={type:"button",title:"Ordered list",fn:{markdown(){this.encloseSelection("","",(e=>`1. ${e.replace(/\r/g,"").replace(/\n/g,"\n1. ")}`))}}},jsToolBar.prototype.elements.md_details={type:"button",title:"Details block",fn:{},title_prompt:"Summary:",default_title:"",prompt(e=""){return window.prompt(this.elements.md_details.title_prompt,e||this.elements.md_details.default_title)}},jsToolBar.prototype.elements.md_details.fn.markdown=function(){const e=this.elements.md_details.prompt.call(this);if(null!==e){let t='<details markdown="1">\n';const o="\n</details>";return e&&(t=`${t}<summary>${e}</summary>\n`),void this.encloseSelection(t,o)}this.textarea.focus()},jsToolBar.prototype.elements.md_aside={type:"button",title:"Aside",fn:{markdown(){this.encloseSelection('<aside markdown="1">\n',"\n</aside>")}}},jsToolBar.prototype.elements.md_space3={type:"space",format:{markdown:!0}},jsToolBar.prototype.elements.md_link={type:"button",title:"Link",shortkey:"KeyL",shortkey_name:"L",fn:{},fncall:{},data:{},popup(e=""){window.the_toolbar=this,this.elements.md_link.data={},window.open(this.elements.md_link.open_url+e,"dc_popup","alwaysRaised=yes,dependent=yes,toolbar=yes,height=420,width=520,menubar=no,resizable=yes,scrollbars=yes,status=no")}},jsToolBar.prototype.elements.md_link.fn.markdown=function(){this.elements.md_link.popup.call(this)},jsToolBar.prototype.elements.md_img={type:"button",title:"External image",fn:{},src_prompt:"Please give image URL:",title_prompt:"Title for this image:",default_title:"",prompt(e="",t=""){let o=t||this.elements.md_img.default_title;const l=window.prompt(this.elements.md_img.src_prompt,e);return l?(o=window.prompt(this.elements.md_img.title_prompt,o),null===o?null:{src:this.stripBaseURL(l),title:o}):null}},jsToolBar.prototype.elements.md_img.fn.markdown=function(){const e=this.elements.md_img.prompt.call(this);if(null!==e&&""!==e){const t="![";let o=`](${e.src}`;return e.title&&(o=`${o} "${e.title}"`),o=`${o})`,void this.encloseSelection(t,o)}this.textarea.focus()},jsToolBar.prototype.elements.md_img_select={type:"button",title:"Image chooser",shortkey:"KeyM",shortkey_name:"M",fn:{},fncall:{},data:{},popup(){window.the_toolbar=this,this.elements.md_img_select.data={},window.open(this.elements.md_img_select.open_url,"dc_popup","alwaysRaised=yes,dependent=yes,toolbar=yes,height=500,width=760,menubar=no,resizable=yes,scrollbars=yes,status=no")}},jsToolBar.prototype.elements.md_img_select.fn.markdown=function(){this.elements.md_img_select.popup.call(this)},jsToolBar.prototype.elements.img_select.fncall.markdown=function(){const e=this.elements.img_select.data;e&&void 0!==e.src?this.encloseSelection("","",(t=>{const o=e=>e.replace("&","&amp;").replace(">","&gt;").replace("<","&lt;").replace('"',"&quot;"),l={left:dotclear.md_options.style.left,right:dotclear.md_options.style.right,center:dotclear.md_options.style.center},n=o(t||e.title);let s=!(""===e.description||!n.length)&&o(e.description);n===s&&(s=!1);const a=n?`${o(dotclear.md_options.img_link_title)}`:"";if(!s&&(!(e.alignment in l)||e.alignment in l&&dotclear.md_options.style.class)){const t=e.alignment in l?`{.${l[e.alignment]}}`:"",o=`![${n}](${e.src})${t}`;return e.link&&n.length&&a.length?`[${o}](${e.url} "${a}")`:o}let i=`<img src="${e.src}" alt="${n}"`,r="<figure";const m=s?`<figcaption>${s}</figcaption>\n`:"";return e.alignment in l&&(s?r=`${r} ${dotclear.md_options.style.class?"class":"style"}="${l[e.alignment]}"`:i=`${i} ${dotclear.md_options.style.class?"class":"style"}="${l[e.alignment]}"`),i=`${i}>`,r=`${r}>`,e.link&&n.length&&(i=`<a href="${e.url}" title="${a}">${i}</a>`),s?`${r}\n${i}\n${m}</figure>`:i})):this.textarea.focus()},jsToolBar.prototype.elements.mp3_insert.fncall.markdown=function(){const e=this.elements.mp3_insert.data;void 0!==e.player&&this.encloseSelection("","",(()=>`\n${e.player}\n`))},jsToolBar.prototype.elements.flv_insert.fncall.markdown=function(){const e=this.elements.flv_insert.data;void 0!==e.player&&this.encloseSelection("","",(()=>`\n${e.player}\n`))},jsToolBar.prototype.elements.md_post_link={type:"button",title:"Link to an entry",shortkey:"KeyE",shortkey_name:"E",fn:{},data:{},popup(){window.the_toolbar=this,this.elements.link.data={},window.open(this.elements.md_post_link.open_url,"dc_popup","alwaysRaised=yes,dependent=yes,toolbar=yes,height=500,width=760,menubar=no,resizable=yes,scrollbars=yes,status=no")}},jsToolBar.prototype.elements.md_post_link.fn.markdown=function(){this.elements.md_post_link.popup.call(this)},jsToolBar.prototype.elements.link.fncall.markdown=function(){const e=this.elements.link.data;if(e&&void 0!==e.href){let t="[";const o=e.title?` "${e.title}"`:"";let l=`](${e.href}${o})`;return e?.hreflang&&(l=`${l}{hreflang=${e.hreflang}}`),window?.getSelection()?.toString()||(t=`${t}${e.href}`),void this.encloseSelection(t,l)}this.textarea.focus()},jsToolBar.prototype.elements.md_footnote={type:"button",title:"Footnote",shortkey:"KeyN",shortkey_name:"N",fn:{markdown(){let e=0;const t=this.textarea.selectionStart,o=this.textarea.selectionEnd,l=this.textarea.value.substring(t,o),n=[...this.textarea.value.matchAll(/\[\^(\d*)\]/g)];n.length>0&&(e=Math.max(...n.map((e=>Number.parseInt(e[1]))))),e+=1;const s=`[^${e}]`;this.textarea.value=this.textarea.value.substring(0,t)+s+this.textarea.value.substring(o),this.textarea.value=`${this.textarea.value}\n${s}: ${l}`,this.textarea.setSelectionRange(t+s.length,t+s.length),this.textarea.focus()}}},jsToolBar.prototype.elements.md_space4={type:"space",format:{markdown:!0}},jsToolBar.prototype.elements.md_preview={type:"button",title:"Preview",shortkey:"KeyP",shortkey_name:"P",fn:{markdown(){dotclear.services("markdownConvert",(e=>{try{const t=JSON.parse(e);if(!t?.success)return void console.log(dotclear.debug&&t?.message?t.message:"Dotclear REST server error");t?.payload.ret&&$.magnificPopup.open({items:{src:`<div class="md_preview"><div class="md_markup">${t.payload.html}</div></div>`,type:"inline"}})}catch(e){console.log(e)}}),(e=>{console.log(e)}),!1,{json:1,md:this.textarea.value})}}},dotclear.mergeDeep(jsToolBar.prototype.elements,dotclear.getData("md_editor"));
